name: Run Amul Product Checker Every 30 Minutes

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install tools (Maven, unzip, jq, XVFB)
        run: |
          sudo apt-get update
          sudo apt-get install -y maven unzip wget jq xvfb

      - name: Install Chrome & ChromeDriver from CfT (last known good version)
        run: |
          VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json \
            | jq -r '.channels.Stable.version')

          echo "Using Chrome version: $VERSION"

          CHROME_URL=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json \
            | jq -r '.channels.Stable.downloads.chrome[] | select(.platform == "linux64") | .url')
          DRIVER_URL=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json \
            | jq -r '.channels.Stable.downloads.chromedriver[] | select(.platform == "linux64") | .url')

          wget -q "$CHROME_URL" -O chrome.zip
          unzip chrome.zip -d chrome
          sudo mv chrome/chrome-linux64/chrome /usr/local/bin/chrome

          wget -q "$DRIVER_URL" -O chromedriver.zip
          unzip chromedriver.zip -d chromedriver
          sudo mv chromedriver/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          chmod +x /usr/local/bin/{chrome,chromedriver}

      - name: Set DISPLAY for headless Chrome
        run: echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Maven Selenium Tests
        run: xvfb-run --auto-servernum mvn clean test
