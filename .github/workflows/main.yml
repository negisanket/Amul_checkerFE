name: Run Amul Product Checker Every 30 Minutes

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      - name: Install Maven
        run: sudo apt-get update && sudo apt-get install -y maven unzip wget

      - name: Install XVFB
        run: sudo apt-get install -y xvfb

      - name: Install Chrome & matching ChromeDriver via Chrome for Testing
        run: |
          VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/latest-versions-per-build.json \
            | jq -r '.branches.stable | .["linux64"].version')
          echo "Detected Chrome for Testing version: $VERSION"
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${VERSION}/linux64/chrome-linux64.zip" -O chrome.zip
          unzip chrome.zip -d chrome
          sudo mv chrome/chrome-linux64/chrome /usr/local/bin/chrome
          wget -q "https://storage.googleapis.com/chrome-for-testing-public/${VERSION}/linux64/chromedriver-linux64.zip" -O chromedriver.zip
          unzip chromedriver.zip
          sudo mv chromedriver /usr/local/bin/chromedriver
          chmod +x /usr/local/bin/{chrome,chromedriver}

      - name: Set DISPLAY for headless Chrome
        run: echo "DISPLAY=:99" >> $GITHUB_ENV

      - name: Run Selenium tests with Maven
        run: xvfb-run --auto-servernum mvn clean test
